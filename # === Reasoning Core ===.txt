# === Reasoning Core ===
class Reasoner:
    def __init__(self, memory):
        self.constraints = []
        self.variables = {}
        self.memory = memory
        self.mutations = MutationLog()

    def add_constraint(self, expr: str):
        left, right = expr.split("=")
        syms = {n: self.variables.get(n, symbols(n)) for n in expr if n.isalpha()}
        eq = Eq(sympify(left, syms), sympify(right, syms))
        self.constraints.append(eq)
        self.mutations.record("add_constraint", expr)

    def solve_for(self, target: str):
        target_sym = self.variables.get(target, symbols(target))
        self.variables[target] = target_sym
        try:
            sol = solve(self.constraints, target_sym, dict=True)
            self.mutations.record("solve", {"target": target, "solution": sol})
            self.memory.store_case(self.constraints, target, sol)
            return sol
        except Exception as e:
            self.mutations.record("error", str(e))
            return None
